name: Lint & Test Fr-API 🃏
on:
  push:
    branches: [ chore/*, feat/*, refactor/* ]
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
jobs:
  lint:
    name: 🚦 ESLint
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3

      - name: ⚙️ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: "19.x"

      - name: 📥 Download deps
        uses: bahmutov/npm-install@v1

      - name: 🔬 Lint
        run: npm run lint

  test:
    name: 🧪 Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3

      - name: ⚙ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: "19.x"

      - name: 📥 Download dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:unit
        env:
          LOG_DIR: '../logs'
          SECRET_KEY: 'secretKey'
          TWILIO_ACCOUNT_SID: 'ACfakeAccountSID'
          TWILIO_AUTH_TOKEN: 'fakeAuthToken'

  intTest:
    env:
      MONGO_URI: 'mongodb://0.0.0.0:27018/test'
      LOG_DIR: '../logs'
      SECRET_KEY: 'secretKey'
      TWILIO_ACCOUNT_SID: 'ACfakeAccountSID'
      TWILIO_AUTH_TOKEN: 'fakeAuthToken'
      ROOT_URI: 'http://localhost:3000'
      DB_MEMORY: 'false'
      DB_IP: '127.0.0.1'
      DB_PORT: '27018'
      CI: true
      MONGO_USERNAME: admin
      MONGO_PASSWORD: adminpassword


    name: 🎛️ Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout repo
        uses: actions/checkout@v3

      - name: ⚙ Setup node
        uses: actions/setup-node@v3
        with:
          node-version: "19.x"

      - name: 📥 Download dependencies
        run: npm ci

      - name: 👷🏽‍ Rebuild bcrypt
        run: npm rebuild --update-binary bcrypt

#      - name: 🍃 🐳 Start MongoDB
#        uses: supercharge/mongodb-github-action@v1.10.0
#        with:
#          mongodb-version: 6.0
#
#      - name: Set SYSTEM_BINARY for MongoMemoryServer
#        run: echo "SYSTEM_BINARY=/usr/bin/mongod" >> $GITHUB_ENV

      - name: 🍃 🐳 Run MongoDB Docker Container
        run: |
          docker run -d --name fr-db -p 27018:27018 mongo

      - name: 🕤 Wait for MongoDB to start
        run: sleep 20

      - name: Run Integration Tests
        run: npm run test:int
