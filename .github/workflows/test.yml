name: Lint & Test Fr-API üÉè
on:
  push:
    branches: [ chore/*, feat/*, refactor/*, test/* ]
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
jobs:
  lint:
    name: üö¶ ESLint
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v3

      - name: ‚öôÔ∏è Setup node
        uses: actions/setup-node@v3
        with:
          node-version: "19.x"

      - name: üì• Download deps
        uses: bahmutov/npm-install@v1

      - name: üî¨ Lint
        run: npm run lint

  test:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v3

      - name: ‚öô Setup node
        uses: actions/setup-node@v3
        with:
          node-version: "19.x"

      - name: üì• Download dependencies
        run: npm ci

      - name: Run tests
        run: npm run test:unit
        env:
          LOG_DIR: '../logs'
          SECRET_KEY: 'secretKey'
          TWILIO_ACCOUNT_SID: 'ACfakeAccountSID'
          TWILIO_AUTH_TOKEN: 'fakeAuthToken'
          PRIVATE_KEY: 'fakePrivateKey'

  intTest:
    env:
      APP_ID: ${{ secrets.APP_ID }}
      APP_SECRET: ${{ secrets.APP_SECRET }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }} # Set the Stripe access key from GitHub secret
      AWS_BUCKET: 'francoisrentals'
      AWS_REGION: 'us-east-2'
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # Set the Stripe access key from GitHub secret
      BUCKET_NAME: 'francoisrentals'
      CI: true
      DB_IP: '127.0.0.1'
      DB_MEMORY: 'false'
      DB_PORT: '27017'
      FR_FIREBASE_PRIVATE_NEW_KEY: '-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDUfCzQtnIOA9xf\nkKGTq/b01oKK7aoaRYJPddyO5BF8xzxmey+C6IzF7W7ScsrTp/bev9sP2AZr1FLV\nPLiSk7R1n5kJegGF+/h/Pjeg4Leh7/41YMo3iCEgYCAB6adcyntSvsYxryhScZIl\nHx1wg6N1MMFclb3+gpIDxVJ4I9l+D/Vf8hA9pFgGBbOUyQhjK69VZa7yCouENHV8\n8yhmsp4uDW0tzEYDyUn3bJKEC1Y+189qAVaLDS6x3COecQrYG8cupDdCmMv0EgbA\nPd/KfzMKOSNRLGSOEqeWIF42z9LrCGFg7ChIpsf+bDd7x8agIBP7dAZZ2VqkOhj+\nD/OnAfFVAgMBAAECggEAA1boRWd4p2u8HOxi/bUoLnTonFJb6AnLoIATtVM0Sye+\ndUXeW0pYXAv9P+V59pWfNaUCRl94yl0N6DgKFpOntGmLuDBosbhiEW3i5e5iNHNX\nJXOd+f1zt9SK7DzF2pl8ErLY3pMIKTOLvnWcutX2zbK0d0YLNGLM9K43O5gkpOyH\n7/ISOXm4l4/O2NTfbn8fP7jJWxc8HRoFE2qkpnv2hBGbAe34GMkMMsTbwGa4CMLf\nm/Lm+6lQBoZV8LVWXwkDal/iSQUVSoflrm2nvoo0eso6GHK6eoUNx4XlyqnIMU9w\nyAiEhv1YtJvXnrsRRBD9cqCWOsuOTNZvdTseGb7ewQKBgQD491fk5se3z8NSW92X\nHoSyi5qJb5chbP3BwHE5RWbYMzncjSnrkAtZOM5yVjV6ghjeF2c/WzKUuOXIPvTE\nWZhVborccBnWow23z6Q97SSH5z9odigRqEevTy2l6NA5f/jruel8BS0o1ZfAe2I+\nVmctN+Sblj0q457F6s+9I2l5uQKBgQDafPsPHjUXMa+jLQ8q1qiKvtlLUZbnxSk8\nk1GzMwnoxJ0dazP+Ta3KBHHBa1t3dHFOEtj9MsNQ8OtOMHESNRj0ovHrv0Q5g2yk\n2uSmSjqZ/QVwnylgAj44Qg66J1TitzS35VIRS3W4haYtyYvPFvSsM+Sz/VNW7Kop\n5l6zkMaSfQKBgQCwD+q+W13dZTXRplmcJt7cjNEqZBnSb4s8W2U2hRfnyMIgcEu2\n5FTCMeP9A24qRppjZNWE/m9UsTT+WVcrC9kogVX98eCz4vcuh860ZGGzIhu7OeO4\nKPMYzLuRWoT2RMO5n+234MlA2VvJqPee8edhGOe4B5UWIYYEnLtwG/zZMQKBgQC4\nac0ukXyWOyXYQOwQaGaR1UxrOk55Cf0oV+AZtPakNW+3qQiVmNMbNG0fqJHnXa1V\nDKuB6xrYcsDpmhGWIKMTuYUgSqw3LyrAatGbWgPkfZ/d0zmFA9+odHkhvpjzU1d3\n8GM4ncybFpORChCrluCliJd9JFD3iYKHIx7DyWsRsQKBgCzInDISHH9not69gcmm\nPMRR+Vudhwvec2WybOg82IhU50UqlDGrBHaZ3RuLwCs9P/T/DwMFml8mVOHA2Qb8\nbEl6wB4NqXJb7O1qx9Q9YydiJD7vwRw6f8IwKtTFPOApCvdBeuVWrSVSdn6mQZQg\nTPJNtsenKLg5J0ng8lt/np7g\n-----END PRIVATE KEY-----\n'
      LOG_DIR: '../logs'
      MONGO_PASSWORD: adminpassword
      MONGO_URI: 'mongodb://0.0.0.0:27017'
      MONGO_USERNAME: admin
      ROOT_URI: 'http://localhost:3000'
      SECRET_KEY: 'secretKey'
      STRIPE_ACCESS_KEY: ${{ secrets.STRIPE_ACCESS_KEY }} # Set the Stripe access key from GitHub secret
      TWILIO_ACCOUNT_SID: 'ACfakeAccountSID'
      TWILIO_AUTH_TOKEN: 'fakeAuthToken'

    name: üéõÔ∏è Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout repo
        uses: actions/checkout@v3

      - name: ‚öô Setup node
        uses: actions/setup-node@v3
        with:
          node-version: "19.x"

      - name: üì• Download dependencies
        run: npm ci

      - name: üë∑üèΩ‚Äç Rebuild bcrypt
        run: npm rebuild --update-binary bcrypt

      - name: üçÉ üê≥ Run MongoDB Docker Container
        run: |
          docker run -d --name fr-db -p 27017:27017 mongo

      - name: üï§ Wait for MongoDB to start
        run: sleep 20

      - name: Run Integration Tests
        run: npm run test:int
        env:
          STRIPE_ACCESS_KEY: ${{ secrets.STRIPE_ACCESS_KEY }}
